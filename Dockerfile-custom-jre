# ==============================================================================
# MULTI-STAGE DOCKERFILE - SPRING BOOT 4 + TOMCAT (OPTIMIZED SIZE)
# ==============================================================================

# Stage 1: Build
FROM maven:3.9.6-eclipse-temurin-21-alpine AS build
WORKDIR /app

# Copy POM files for dependency caching
COPY pom.xml ./pom.xml
COPY payments-api/pom.xml ./payments-api/pom.xml
COPY payment-security-starter/pom.xml ./payment-security-starter/pom.xml
COPY payments-app/pom.xml ./payments-app/pom.xml

# Download dependencies
RUN mvn -f pom.xml -pl payments-app -am dependency:go-offline -B

# Copy source code
COPY payments-api ./payments-api
COPY payment-security-starter ./payment-security-starter
COPY payments-app ./payments-app

# Build application
RUN mvn -f pom.xml -pl payments-app -am clean package -DskipTests \
    -Dmaven.test.skip=true \
    -Dmaven.javadoc.skip=true \
    --batch-mode \
    --no-transfer-progress

# ==============================================================================
# Stage 2: Create Custom JRE with jlink
# ==============================================================================
FROM eclipse-temurin:21-jdk-alpine AS jre-build

# Spring Boot 4 + Tomcat required modules
RUN $JAVA_HOME/bin/jlink \
    --add-modules \
java.base,\
java.compiler,\
java.desktop,\
java.instrument,\
java.logging,\
java.management,\
java.naming,\
java.net.http,\
java.prefs,\
java.scripting,\
java.security.jgss,\
java.security.sasl,\
java.sql,\
java.xml,\
jdk.crypto.cryptoki,\
jdk.crypto.ec,\
jdk.unsupported \
    --strip-debug \
    --no-man-pages \
    --no-header-files \
    --compress=2 \
    --output /javaruntime

# ==============================================================================
# Stage 3: Runtime
# ==============================================================================
FROM alpine:3.19

ENV JAVA_HOME=/opt/java/openjdk
ENV PATH="${JAVA_HOME}/bin:${PATH}"

COPY --from=jre-build /javaruntime $JAVA_HOME

WORKDIR /app

# Create non-root user
RUN addgroup -S spring && adduser -S spring -G spring && chown -R spring:spring /app

# Install wget for healthcheck
RUN apk add --no-cache wget

# Copy application JAR
COPY --from=build --chown=spring:spring /app/payments-app/target/*.jar app.jar

USER spring:spring

EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1

ENTRYPOINT ["java","-jar","-Dserver.port=8080","/app/app.jar"]

# ==============================================================================
# MODULE BREAKDOWN BY TECHNOLOGY
# ==============================================================================
#
# CORE JAVA:
# - java.base           : Core Java classes (always required)
# - java.logging        : Java logging framework
# - jdk.unsupported     : Internal APIs used by frameworks
#
# SPRING BOOT:
# - java.desktop        : java.beans.* (Spring dependency injection)
# - java.instrument     : Java agents, instrumentation
# - java.management     : JMX monitoring
# - java.prefs          : Preferences API
# - java.scripting      : Expression language support
#
# TOMCAT (EMBEDDED):
# - java.naming         : JNDI support
# - java.security.jgss  : GSS/Kerberos authentication
# - java.security.sasl  : SASL authentication
#
# DATABASE/PERSISTENCE:
# - java.sql            : JDBC support
#
# WEB/HTTP:
# - java.net.http       : HTTP client
# - java.xml            : XML parsing (web.xml, spring configs)
# - java.compiler       : Annotation processing (javax.lang.model.*, javax.tools.*)
#
# SECURITY/CRYPTO:
# - jdk.crypto.cryptoki : PKCS#11 crypto provider
# - jdk.crypto.ec       : Elliptic curve cryptography (SSL/TLS)
#
# ==============================================================================